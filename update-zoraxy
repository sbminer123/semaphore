---
- name: Update Zoraxy to the latest version
  hosts: all
  become: true

  tasks:
    - name: Fetch the latest Zoraxy release version
      shell: |
        curl -s https://api.github.com/repos/tobychui/zoraxy/releases/latest | jq -r ".tag_name"
      register: latest_version
      failed_when: latest_version.stdout == ""  # Fail if no version is fetched
      changed_when: false

    - name: Debug latest version
      debug:
        var: latest_version.stdout

    - name: Set architecture variable
      shell: |
        ARCH=$(uname -m)
        if [ "$ARCH" == "x86_64" ]; then
            echo "amd64"
        elif [ "$ARCH" == "aarch64" ]; then
            echo "arm64"
        else
            echo "Unsupported architecture"
            exit 1
        fi
      register: architecture
      failed_when: architecture.stdout == "Unsupported architecture"

    - name: Debug architecture
      debug:
        var: architecture.stdout

    - name: Download the latest Zoraxy binary
      get_url:
        url: "https://github.com/tobychui/zoraxy/releases/download/{{ latest_version.stdout }}/zoraxy-linux-{{ architecture.stdout }}"
        dest: /usr/local/bin/zoraxy
        mode: '0755'

    - name: Stop Zoraxy service
      service:
        name: zoraxy
        state: stopped

    - name: Start Zoraxy service
      service:
        name: zoraxy
        state: started

    - name: Verify Zoraxy version
      command: zoraxy --version
      register: zoraxy_version

    - name: Display the installed Zoraxy version
      debug:
        msg: "Zoraxy updated to version: {{ zoraxy_version.stdout }}"
